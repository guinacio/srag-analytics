{"type":"entity","name":"SRAGReportAgent","entityType":"Service","observations":["[2026-01-17] Purpose: Main LangGraph orchestrator implementing fan-out/fan-in parallel execution pattern for SRAG report generation","[2026-01-17] Location: backend/agents/report_agent.py","[2026-01-17] Pattern: Uses custom reducers (keep_first, keep_latest, merge_dicts, merge_lists) for parallel state management","[2026-01-17] Flow: START -> [calculate_metrics, fetch_news, generate_charts] parallel -> write_report -> create_audit -> END","[2026-01-17] Quirk: Uses ReportState TypedDict with Annotated reducers - custom implementation, not built-in MessagesState","[2026-01-17] Tech Debt: Imports 'from operator import add' at line 16 but NEVER uses it - dead import","[2026-01-17] Uses GPT-4o with temperature=0.3 (README says 0.0 - documentation mismatch)","[2026-01-17] Checkpointer: PostgresSaver with direct Connection.connect() - older pattern, newer is from_conn_string()","[2026-01-17] MODERNIZED: PostgresSaver now uses from_conn_string() pattern instead of manual Connection.connect()","[2026-01-17] MODEL UPDATE: Now uses GPT-5 (was GPT-4o) for report generation"]}
{"type":"entity","name":"MetricsTool","entityType":"Module","observations":["[2026-01-17] Purpose: Calculates 4 required SRAG health metrics using pre-defined SQL queries (NOT LLM-generated)","[2026-01-17] Location: backend/tools/metrics_tool.py","[2026-01-17] Metrics: case_increase_rate, mortality_rate, icu_occupancy_rate, vaccination_rate","[2026-01-17] Chart data: get_daily_cases_chart_data() (30 days), get_monthly_cases_chart_data() (12 months)","[2026-01-17] Design Decision: Uses hardcoded SQL for security and predictability - no SQL injection from LLM hallucinations","[2026-01-17] Queries daily_metrics and monthly_metrics materialized tables"]}
{"type":"entity","name":"NewsTool","entityType":"Module","observations":["[2026-01-17] Purpose: Fetches SRAG-related news articles using Tavily Search API with Portuguese queries","[2026-01-17] Location: backend/tools/news_tool.py","[2026-01-17] Methods: search_srag_news(), get_recent_context(), format_for_citation(), extract_publication_dates()","[2026-01-17] Uses GPT-4o-mini for extracting publication dates from article content","[2026-01-17] Tech Debt: state_names mapping only has 9 of 27 Brazilian states - incomplete mapping at lines 76-103","[2026-01-17] Queries: Portuguese search terms including 'SRAG síndrome respiratória aguda grave COVID-19'","[2026-01-17] FIXED: Completed Brazilian state mapping - now includes all 27 states (was only 9)","[2026-01-17] MODEL UPDATE: Now uses GPT-5-mini (was GPT-4o-mini) for date extraction","[2026-01-18] CRITICAL FIX: gpt-5-* models have extended thinking that consumes tokens. max_completion_tokens must be 1000+ or model returns empty content with finish_reason='length'. Low values (20-100) cause complete output failure."]}
{"type":"entity","name":"SafeSQLTool","entityType":"Module","observations":["[2026-01-17] Purpose: Safe SQL query execution with multiple security guardrails - DESIGNED BUT NOT USED IN PRODUCTION","[2026-01-17] Location: backend/tools/sql_tool.py","[2026-01-17] Security: Read-only PostgreSQL user, table allowlist, 30s timeout, 10K row limit, SELECT-only validation","[2026-01-17] Intended Use: Future user-driven data exploration features (separate endpoint)","[2026-01-17] Tables allowed: srag_cases, data_dictionary, daily_metrics, monthly_metrics","[2026-01-17] Uses gpt-5-mini model at line 94 for cost-effective SQL generation"]}
{"type":"entity","name":"DictionaryRAGTool","entityType":"Module","observations":["[2026-01-17] Purpose: RAG-based semantic search over SRAG data dictionary using pgvector embeddings","[2026-01-17] Location: backend/tools/rag_tool.py","[2026-01-17] Methods: semantic_search(), get_field_by_name(), explain_field(), get_context_for_query()","[2026-01-17] Uses: text-embedding-3-small model for embeddings","[2026-01-17] Quirk: Line 97 imports 'from sqlalchemy import or_' INSIDE the function - should be at module level","[2026-01-17] Fallback: Text-based search when semantic search returns no results","[2026-01-17] FIXED: Moved 'from sqlalchemy import or_' to module level"]}
{"type":"entity","name":"Guardrails","entityType":"Module","observations":["[2026-01-17] Purpose: Security layer for PII detection, input sanitization, output validation, and audit logging","[2026-01-17] Location: backend/agents/guardrails.py","[2026-01-17] PII Patterns: CPF (Brazilian ID), RG, phone, email, credit card - all get scrubbed/redacted","[2026-01-17] Functions: scrub_pii(), sanitize_input(), validate_output(), apply_output_schema(), log_security_event()","[2026-01-17] Integrated: Called before LLM invocation (input) and after (output) in report generation"]}
{"type":"entity","name":"Prompts","entityType":"Module","observations":["[2026-01-17] Purpose: Centralized LLM prompt management for all agent operations","[2026-01-17] Location: backend/agents/prompts.py","[2026-01-17] Prompts: REPORT_SYSTEM_PROMPT (Portuguese), FIELD_EXPLANATION_PROMPT, NEWS_FILTERING_PROMPT, DATE_EXTRACTION_SYSTEM_PROMPT, SQL_SYSTEM_PROMPT","[2026-01-17] Builder functions: build_report_user_prompt(), build_date_extraction_prompt(), build_sql_generation_prompt()","[2026-01-17] Language: All report prompts in Portuguese for Brazilian healthcare context"]}
{"type":"entity","name":"FastAPIBackend","entityType":"Service","observations":["[2026-01-17] Purpose: REST API server exposing 13 endpoints for report generation, metrics, news, charts, and dictionary","[2026-01-17] Location: backend/main.py (311 lines)","[2026-01-17] Endpoints: /report, /metrics, /news, /charts/daily, /charts/monthly, /dictionary/*, /sql/*, /health","[2026-01-17] Tech Debt: Line 8 imports JSONResponse but NEVER uses it - dead import","[2026-01-17] Security Issue: Lines 57-58 set CORS allow_origins=['*'] - open to all origins, acknowledged in comment as wrong","[2026-01-17] Lifecycle: Uses lifespan context manager for init_db() on startup","[2026-01-17] FIXED: Removed unused JSONResponse import","[2026-01-17] FIXED: CORS now configurable via ALLOWED_ORIGINS environment variable"]}
{"type":"entity","name":"StreamlitFrontend","entityType":"Service","observations":["[2026-01-17] Purpose: Interactive dashboard for SRAG analytics with metrics, charts, news, and data dictionary exploration","[2026-01-17] Location: frontend/app.py","[2026-01-17] Tabs: Dashboard (metrics display), Metrics Breakdown, Recent News, Data Dictionary","[2026-01-17] Config Issue: Line 19 hardcodes API_BASE_URL='http://localhost:8000' - should be environment variable","[2026-01-17] Filters: Days (1-365) and State selector in sidebar","[2026-01-17] FIXED: API_BASE_URL now configurable via environment variable","[2026-01-18] Added chat_audit_trail session state for tracking all chat interactions with timestamps, tool calls, and thread IDs","[2026-01-18] Audit trail now includes both report generation audit and chat interactions in a combined JSON export","[2026-01-18] Chat tab now includes 'Limpar Chat' button that resets chat history and audit trail"]}
{"type":"entity","name":"SRAGCase","entityType":"DataModel","observations":["[2026-01-17] Purpose: Main fact table storing individual SRAG case records from DATASUS","[2026-01-17] Location: backend/db/models.py","[2026-01-17] Scale: ~165K rows, 100+ columns covering temporal, geographic, demographic, clinical, risk factors, hospitalization, vaccination, and outcome data","[2026-01-17] Indexes: dt_notific, sg_uf, uti, vacina, vacina_cov, evolucao for query performance","[2026-01-17] Key Fields: notification_date, symptom_date, state, municipality, age, sex, fever, cough, dyspnea, ICU dates, vaccination status, outcome"]}
{"type":"entity","name":"DailyMetrics","entityType":"DataModel","observations":["[2026-01-17] Purpose: Materialized daily aggregate metrics for fast dashboard queries","[2026-01-17] Location: backend/db/models.py","[2026-01-17] Fields: metric_date, new_cases, deaths, icu_admissions, state filter","[2026-01-17] Updated: Refreshed periodically from SRAGCase aggregations"]}
{"type":"entity","name":"MonthlyMetrics","entityType":"DataModel","observations":["[2026-01-17] Purpose: Materialized monthly aggregate metrics for historical trending","[2026-01-17] Location: backend/db/models.py","[2026-01-17] Fields: month, total_cases, deaths, icu_admissions","[2026-01-17] Used by: get_monthly_cases_chart_data() for 12-month charts"]}
{"type":"entity","name":"DataDictionary","entityType":"DataModel","observations":["[2026-01-17] Purpose: Field definitions with pgvector embeddings for semantic search","[2026-01-17] Location: backend/db/models.py","[2026-01-17] Fields: field_name, field_description, valid_values, embedding (vector)","[2026-01-17] Populated by: dictionary_parser.py which extracts from DATASUS data dictionary PDF/docs","[2026-01-17] Embeddings: Generated using text-embedding-3-small via OpenAI"]}
{"type":"entity","name":"DatabaseConnection","entityType":"Module","observations":["[2026-01-17] Purpose: SQLAlchemy database connection management with main and read-only engines","[2026-01-17] Location: backend/db/connection.py","[2026-01-17] Engines: Main engine (full permissions), ReadOnly engine (for sql_tool security)","[2026-01-17] Tech Debt: get_db_session() at lines 75-81 is BROKEN - closes connection before return can be used","[2026-01-17] Tech Debt: get_readonly_db() at lines 65-72 is NEVER CALLED anywhere","[2026-01-17] Context managers: get_db() for session management","[2026-01-17] FIXED: Removed dead get_db_session() and get_readonly_db() functions"]}
{"type":"entity","name":"Settings","entityType":"Configuration","observations":["[2026-01-17] Purpose: Pydantic BaseSettings for centralized environment configuration","[2026-01-17] Location: backend/config/settings.py","[2026-01-17] Config: Database credentials (main + readonly), API keys (OpenAI, Tavily), LangSmith (optional)","[2026-01-17] Security Issue: Lines 21, 25 have hardcoded default passwords (srag_password, readonly_pass)","[2026-01-17] Security Issue: Line 39 has default secret_key='change-this-in-production'","[2026-01-17] Tech Debt: Lines 58-60 async_database_url property is a NO-OP (replaces string with identical string)","[2026-01-17] Properties: database_url, readonly_database_url for connection strings","[2026-01-17] Note: Hardcoded default passwords are INTENTIONAL for this challenge project - provides reviewers with all necessary secrets","[2026-01-17] FIXED: Removed dead async_database_url property (was a no-op)","[2026-01-17] ADDED: model_validator for API key validation at startup","[2026-01-17] ADDED: Clarifying comment explaining intentional hardcoded passwords for challenge project"]}
{"type":"entity","name":"DockerCompose","entityType":"Configuration","observations":["[2026-01-17] Purpose: Service orchestration for PostgreSQL + FastAPI backend containers","[2026-01-17] Location: docker-compose.yml","[2026-01-17] Services: postgres (port 5432 with pgvector), backend (port 8000)","[2026-01-17] Volumes: postgres_data for persistence, ./backend and ./data mounted","[2026-01-17] Network: srag_network (bridge driver)","[2026-01-17] Healthchecks: pg_isready for postgres, GET /health for backend"]}
{"type":"entity","name":"DataIngestion","entityType":"Module","observations":["[2026-01-17] Purpose: DATASUS CSV to PostgreSQL ETL pipeline","[2026-01-17] Location: backend/db/ingestion.py","[2026-01-17] Functions: parse_date(), parse_int(), clean_row() for field mapping","[2026-01-17] Processing: Batch insert with configurable size, data quality validation","[2026-01-17] Scale: Processes ~165K rows, 100 columns from DATASUS CSV files"]}
{"type":"entity","name":"FanOutFanInPattern","entityType":"Pattern","observations":["[2026-01-17] Description: Parallel execution pattern where multiple independent nodes execute concurrently then converge","[2026-01-17] Implementation: START branches to 3 nodes (calculate_metrics, fetch_news, generate_charts), all converge at write_report","[2026-01-17] Location: backend/agents/report_agent.py lines 121-147","[2026-01-17] Performance: Reduces total latency by ~40% (20s sequential -> 12s parallel)","[2026-01-17] LangGraph Compliance: Matches official docs pattern using standard edges from START to multiple nodes","[2026-01-17] Caveat: Updates from parallel superstep may not be ordered consistently - need reducers for deterministic state"]}
{"type":"entity","name":"CustomReducersPattern","entityType":"Pattern","observations":["[2026-01-17] Description: Custom state merge functions for handling parallel node updates to shared state","[2026-01-17] Location: backend/agents/report_agent.py lines 28-59","[2026-01-17] Reducers: keep_first (config fields), keep_latest (results), merge_dicts (metrics/charts), merge_lists (citations)","[2026-01-17] Applied via: Annotated[Type, reducer_func] in ReportState TypedDict","[2026-01-17] LangGraph Compliance: Matches docs pattern for custom reducers with TypedDict state schemas","[2026-01-17] Alternative: Could use built-in MessagesState with add_messages reducer for messages field","[2026-01-17] BUG FIX: keep_first reducer now treats 0 as 'not set' for numeric types. Previously, if LangGraph initialized state with days=0, keep_first(0, 45) returned 0 instead of 45."]}
{"type":"entity","name":"PIIDetectionPattern","entityType":"Pattern","observations":["[2026-01-17] Description: Input/output security layer that detects and redacts Brazilian PII patterns","[2026-01-17] Location: backend/agents/guardrails.py","[2026-01-17] Patterns detected: CPF, RG, phone numbers, email addresses, credit cards","[2026-01-17] Integration: sanitize_input() before LLM call, validate_output() after","[2026-01-17] Logging: log_security_event() for audit trail of all security operations"]}
{"type":"entity","name":"RAGSemanticSearchPattern","entityType":"Pattern","observations":["[2026-01-17] Description: Vector similarity search over data dictionary using pgvector and OpenAI embeddings","[2026-01-17] Location: backend/tools/rag_tool.py","[2026-01-17] Embedding model: text-embedding-3-small","[2026-01-17] Search: Cosine similarity in PostgreSQL via pgvector extension","[2026-01-17] Fallback: Text-based search when semantic search returns no results above threshold"]}
{"type":"entity","name":"DecisionPreDefinedSQL","entityType":"Decision","observations":["[2026-01-17] Context: Need to query database for SRAG metrics but LLM-generated SQL poses security and reliability risks","[2026-01-17] Choice: Use hardcoded, pre-validated SQL queries in MetricsTool instead of LLM-generated SQL","[2026-01-17] Alternatives Rejected: LangChain SQLAgent (hallucination risk), dynamic query generation (injection risk)","[2026-01-17] Consequences: More reliable, auditable, no injection vulnerabilities, but less flexible","[2026-01-17] Status: Current - SafeSQLTool exists but NOT used in production for this reason","[2026-01-17] Location: Design documented in README.md lines 187-189"]}
{"type":"entity","name":"DecisionReadOnlyDBUser","entityType":"Decision","observations":["[2026-01-17] Context: sql_tool designed for future user-driven exploration needs security isolation","[2026-01-17] Choice: Create srag_readonly PostgreSQL user with SELECT-only permissions on whitelisted tables","[2026-01-17] Implementation: infra/init.sql creates user, backend/db/connection.py provides readonly engine","[2026-01-17] Tables allowed: srag_cases, data_dictionary, daily_metrics, monthly_metrics","[2026-01-17] Consequences: Defense-in-depth even if LLM generates malicious SQL","[2026-01-17] Status: Current"]}
{"type":"entity","name":"DecisionPostgresCheckpointer","entityType":"Decision","observations":["[2026-01-17] Context: Need durable state persistence for LangGraph agent execution","[2026-01-17] Choice: Use langgraph-checkpoint-postgres with PostgresSaver for production checkpointing","[2026-01-17] Alternatives Rejected: InMemorySaver (not durable), SqliteSaver (not production-ready)","[2026-01-17] Implementation: PostgresSaver at backend/agents/report_agent.py lines 104-116","[2026-01-17] Improvement: Could use from_conn_string() context manager pattern (newer, cleaner)","[2026-01-17] Status: Current - provides audit trail and recovery capabilities"]}
{"type":"entity","name":"SRAGChatAgent","entityType":"Service","observations":["[2026-01-17] Purpose: ReAct-style conversational agent for interactive SRAG data exploration","[2026-01-17] Location: backend/agents/chat_agent.py","[2026-01-17] Pattern: Uses ReAct loop - assistant decides tools, executes, synthesizes response","[2026-01-17] Tools: query_database (SQL), search_news (Tavily), lookup_field (RAG), get_metrics (MetricsTool)","[2026-01-17] Checkpointer: PostgresSaver for conversation persistence across sessions","[2026-01-17] Language: Portuguese-only responses per system prompt","[2026-01-17] Paradigm: AUTONOMOUS agent (vs ORCHESTRATED report_agent) - demonstrates both patterns","[2026-01-17] MODEL UPDATE: Now uses GPT-5-mini (was GPT-4o) for conversational responses","[2026-01-17] FIX: search_news tool now uses optimized SRAG query terms and 30-day default (was 7 days)","[2026-01-17] ENHANCEMENT: System prompt now enforces 3-step SQL workflow: (1) get_table_schema, (2) lookup_field for column semantics, (3) write query","[2026-01-17] ENHANCEMENT: lookup_field docstring updated with examples showing value mappings (EVOLUCAO, VACINA_COV, UTI)"]}
{"type":"entity","name":"ReActPattern","entityType":"Pattern","observations":["[2026-01-17] Description: Iterative reasoning pattern where agent decides which tool to use, executes, observes result, and repeats until done","[2026-01-17] Implementation: LangGraph StateGraph with assistant and tools nodes, conditional routing based on tool_calls","[2026-01-17] Location: backend/agents/chat_agent.py","[2026-01-17] Flow: START -> assistant -> [tools if tool_calls else END] -> assistant -> ...","[2026-01-17] Contrast: Unlike fan-out/fan-in (parallel, deterministic), ReAct is sequential and dynamic"]}
{"type":"relation","from":"FastAPIBackend","to":"SRAGReportAgent","relationType":"calls"}
{"type":"relation","from":"FastAPIBackend","to":"MetricsTool","relationType":"calls"}
{"type":"relation","from":"FastAPIBackend","to":"NewsTool","relationType":"calls"}
{"type":"relation","from":"FastAPIBackend","to":"DictionaryRAGTool","relationType":"calls"}
{"type":"relation","from":"SRAGReportAgent","to":"MetricsTool","relationType":"calls"}
{"type":"relation","from":"SRAGReportAgent","to":"NewsTool","relationType":"calls"}
{"type":"relation","from":"SRAGReportAgent","to":"Guardrails","relationType":"calls"}
{"type":"relation","from":"SRAGReportAgent","to":"Prompts","relationType":"imports"}
{"type":"relation","from":"MetricsTool","to":"DailyMetrics","relationType":"queries"}
{"type":"relation","from":"MetricsTool","to":"MonthlyMetrics","relationType":"queries"}
{"type":"relation","from":"MetricsTool","to":"SRAGCase","relationType":"queries"}
{"type":"relation","from":"DictionaryRAGTool","to":"DataDictionary","relationType":"queries"}
{"type":"relation","from":"SafeSQLTool","to":"DatabaseConnection","relationType":"depends_on"}
{"type":"relation","from":"SafeSQLTool","to":"SRAGCase","relationType":"queries"}
{"type":"relation","from":"FastAPIBackend","to":"DatabaseConnection","relationType":"depends_on"}
{"type":"relation","from":"FastAPIBackend","to":"Settings","relationType":"configures"}
{"type":"relation","from":"SRAGReportAgent","to":"Settings","relationType":"configures"}
{"type":"relation","from":"DatabaseConnection","to":"Settings","relationType":"configures"}
{"type":"relation","from":"DataIngestion","to":"SRAGCase","relationType":"persists_to"}
{"type":"relation","from":"DataIngestion","to":"DatabaseConnection","relationType":"depends_on"}
{"type":"relation","from":"StreamlitFrontend","to":"FastAPIBackend","relationType":"communicates_with"}
{"type":"relation","from":"SRAGReportAgent","to":"FanOutFanInPattern","relationType":"implements"}
{"type":"relation","from":"SRAGReportAgent","to":"CustomReducersPattern","relationType":"implements"}
{"type":"relation","from":"Guardrails","to":"PIIDetectionPattern","relationType":"implements"}
{"type":"relation","from":"DictionaryRAGTool","to":"RAGSemanticSearchPattern","relationType":"implements"}
{"type":"relation","from":"MetricsTool","to":"DecisionPreDefinedSQL","relationType":"implements"}
{"type":"relation","from":"SafeSQLTool","to":"DecisionReadOnlyDBUser","relationType":"implements"}
{"type":"relation","from":"SRAGReportAgent","to":"DecisionPostgresCheckpointer","relationType":"implements"}
{"type":"relation","from":"DockerCompose","to":"FastAPIBackend","relationType":"configures"}
{"type":"relation","from":"DockerCompose","to":"DatabaseConnection","relationType":"configures"}
{"type":"relation","from":"FastAPIBackend","to":"SRAGChatAgent","relationType":"calls"}
{"type":"relation","from":"SRAGChatAgent","to":"SafeSQLTool","relationType":"calls"}
{"type":"relation","from":"SRAGChatAgent","to":"NewsTool","relationType":"calls"}
{"type":"relation","from":"SRAGChatAgent","to":"DictionaryRAGTool","relationType":"calls"}
{"type":"relation","from":"SRAGChatAgent","to":"MetricsTool","relationType":"calls"}
{"type":"relation","from":"SRAGChatAgent","to":"Guardrails","relationType":"calls"}
{"type":"relation","from":"SRAGChatAgent","to":"ReActPattern","relationType":"implements"}
{"type":"relation","from":"SRAGChatAgent","to":"DecisionPostgresCheckpointer","relationType":"implements"}
{"type":"relation","from":"StreamlitFrontend","to":"SRAGChatAgent","relationType":"communicates_with"}